<UserControl x:Class="Clash_WPF.Views.SettingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:Clash_WPF.Converters">

    <UserControl.Resources>
        <conv:NullToVisibilityConverter x:Key="NullToVisConv"/>
    </UserControl.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="4">
            <TextBlock Text="设置" Style="{StaticResource PageTitle}"/>

            <!-- Core Settings -->
            <Border Style="{StaticResource Card}" Margin="0,0,0,16">
                <StackPanel>
                    <TextBlock Text="内核设置" Style="{StaticResource SectionTitle}"/>

                    <TextBlock Text="Clash/Mihomo 内核路径" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12" Margin="0,0,0,4"/>
                    <DockPanel Margin="0,0,0,12">
                        <Button Content="浏览" DockPanel.Dock="Right" Style="{StaticResource SecondaryButton}"
                                Command="{Binding BrowseCorePathCommand}" Margin="8,0,0,0" Padding="12,8"/>
                        <TextBox Text="{Binding CorePath, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource ModernTextBox}"/>
                    </DockPanel>

                    <TextBlock Text="配置文件目录" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12" Margin="0,0,0,4"/>
                    <DockPanel Margin="0,0,0,12">
                        <Button Content="浏览" DockPanel.Dock="Right" Style="{StaticResource SecondaryButton}"
                                Command="{Binding BrowseConfigDirCommand}" Margin="8,0,0,0" Padding="12,8"/>
                        <TextBox Text="{Binding ConfigDir, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource ModernTextBox}"/>
                    </DockPanel>

                    <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                        <CheckBox IsChecked="{Binding AutoStartCore}" Style="{StaticResource ToggleSwitch}" VerticalAlignment="Center"/>
                        <TextBlock Text="启动时自动运行内核" Foreground="{StaticResource TextPrimaryBrush}"
                                   FontSize="13" Margin="12,0,0,0" VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- API Settings -->
            <Border Style="{StaticResource Card}" Margin="0,0,0,16">
                <StackPanel>
                    <TextBlock Text="API 设置" Style="{StaticResource SectionTitle}"/>

                    <TextBlock Text="外部控制地址" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12" Margin="0,0,0,4"/>
                    <TextBox Text="{Binding ApiUrl, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource ModernTextBox}" Margin="0,0,0,12"/>

                    <TextBlock Text="API 密钥" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12" Margin="0,0,0,4"/>
                    <TextBox Text="{Binding ApiSecret, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource ModernTextBox}" Margin="0,0,0,12"/>

                    <TextBlock Text="混合端口 (Mixed Port)" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12" Margin="0,0,0,4"/>
                    <TextBox Text="{Binding MixedPort, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource ModernTextBox}" Width="120" HorizontalAlignment="Left"/>
                </StackPanel>
            </Border>

            <!-- Actions -->
            <Border Style="{StaticResource Card}" Margin="0,0,0,16">
                <StackPanel>
                    <TextBlock Text="操作" Style="{StaticResource SectionTitle}"/>
                    <WrapPanel>
                        <Button Content="保存设置" Style="{StaticResource PrimaryButton}"
                                Command="{Binding SaveCommand}" Margin="0,0,8,8"/>
                        <Button Content="重启内核" Style="{StaticResource SecondaryButton}"
                                Command="{Binding RestartCoreCommand}" Margin="0,0,8,8"/>
                        <Button Content="打开数据目录" Style="{StaticResource SecondaryButton}"
                                Command="{Binding OpenDataFolderCommand}" Margin="0,0,8,8"/>
                    </WrapPanel>
                </StackPanel>
            </Border>

            <!-- TUN Driver -->
            <Border Style="{StaticResource Card}" Margin="0,0,0,16">
                <StackPanel>
                    <TextBlock Text="TUN 模式" Style="{StaticResource SectionTitle}"/>
                    <TextBlock Text="TUN 模式需要 wintun.dll 驱动和管理员权限才能使用。点击“启用/安装”将在缺失时下载并写入 DLL；“禁用”仅停止使用并保留 DLL 文件以便将来快速启用。"
                               Foreground="{StaticResource TextSecondaryBrush}" FontSize="12" Margin="0,0,0,12"
                               TextWrapping="Wrap"/>

                    <WrapPanel VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,12,0">
                            <CheckBox IsChecked="{Binding TunEnabled, Mode=TwoWay}" Style="{StaticResource ToggleSwitch}" VerticalAlignment="Center"/>
                            <TextBlock Text="启用 TUN 模式" Foreground="{StaticResource TextPrimaryBrush}" FontSize="13" Margin="12,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>

                        <Button Style="{StaticResource SecondaryButton}"
                                Command="{Binding RestartAsAdminCommand}" Margin="0,0,8,8" Padding="14,8">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#xE7EF;" FontFamily="Segoe MDL2 Assets" FontSize="13" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                <TextBlock Text="以管理员身份重启" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </WrapPanel>
                </StackPanel>
            </Border>

            <!-- Status -->
            <Border Background="#20ffffff" CornerRadius="6" Padding="12,10" Margin="0,0,0,8"
                    Visibility="{Binding StatusMessage, Converter={StaticResource NullToVisConv}}">
                <TextBlock Text="{Binding StatusMessage}" Foreground="#e2e8f0"
                           FontSize="13" TextWrapping="Wrap" LineHeight="22"/>
            </Border>
        </StackPanel>
    </ScrollViewer>
</UserControl>
